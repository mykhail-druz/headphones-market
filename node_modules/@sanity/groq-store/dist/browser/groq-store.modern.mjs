import e from"groq";export{default as groq}from"groq";import t from"fast-deep-equal";import{throttle as r}from"throttle-debounce";import{parse as n,evaluate as o}from"groq-js";import{applyPatch as i}from"mendoza";function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},s.apply(this,arguments)}const a=(e,t,r)=>{(e=>"undefined"!=typeof window&&e.addEventListener===window.EventSource.prototype.addEventListener)(e)&&e.addEventListener(t,r,!1),e.addEventListener(t,r)};function c(e,t,r){const{projectId:n,dataset:o,token:i}=t,s=new e(`https://${n}.api.sanity.io/v1/data/listen/${o}?query=*&effectFormat=mendoza`,{withCredentials:!0,headers:i?{Authorization:`Bearer ${i}`}:void 0});var c;return a(s,"welcome",r.open),a(s,"mutation",(c=r.next,e=>{let t;try{t=JSON.parse(e.data)}catch(e){return}c(t)})),a(s,"channelError",e=>{let t;s.close();try{t=JSON.parse(e.data)}catch(e){return void r.error(new Error("Unknown error parsing listener message"))}r.error(new Error(t.message||t.error||`Listener returned HTTP ${t.statusCode}`))}),a(s,"error",e=>{const t="undefined"!=typeof window&&window.location.origin,n=t?`, and that the CORS-origin (${t}) is allowed`:"",o=function(e){return"object"==typeof e&&null!==e&&"message"in e}(e)?` (${e.message})`:"";r.error(new Error(`Error establishing listener - check that the project ID and dataset are correct${n}${o}`))}),{unsubscribe:()=>Promise.resolve(s.close())}}function u(e){return e._id.startsWith("drafts.")?e._id.slice(7):e._id}function d(e,t){const r=s({},e);return delete r._rev,i(r,t)}function l(){return Promise.resolve()}let f,p=e=>e;const h=async function({projectId:e,dataset:t,token:r,documentLimit:n,includeTypes:o=[]}){const i=`https://${e}.api.sanity.io/v1/data/export/${t}?${o.length>0?new URLSearchParams({types:null==o?void 0:o.join(",")}):""}`,s=r?{Authorization:`Bearer ${r}`}:void 0,a=await fetch(i,{credentials:"include",headers:s});if(200!==a.status)throw new Error(`Error streaming dataset: ${c=await a.json(),"object"==typeof c&&"error"in c&&"message"in c?c.message||c.error:"<unknown error>"}`);var c;const u=function(e){if(!e)throw new Error("Failed to read body from response");let t,r=!1;function n(){r=!0,t&&t.cancel()}return new ReadableStream({start(o){t=e.getReader();const i=new TextDecoder;let s="";t.read().then(async function e(a){if(a.done){if(r)return;return s=s.trim(),0===s.length||o.enqueue(JSON.parse(s)),void o.close()}s+=i.decode(a.value,{stream:!0});const c=s.split("\n");for(let e=0;e<c.length-1;++e){const t=c[e].trim();if(0!==t.length)try{o.enqueue(JSON.parse(t))}catch(e){return o.error(e),void n()}}if(s=c[c.length-1],t)try{e(await t.read())}catch(e){o.error(e)}}).catch(e=>o.error(e))},cancel:n})}(a.body),d=u.getReader(),l=[];let f,p;do{if(f=await d.read(),p=f.value,m(p))throw new Error(`Error streaming dataset: ${p.error}`);if(p&&!p._id.startsWith("_.")&&l.push(p),n&&l.length>n)throw d.cancel("Reached document limit"),new Error(`Error streaming dataset: Reached limit of ${n} documents. Try using the includeTypes option to reduce the amount of documents, or increase the limit.`)}while(!f.done);return l};function m(e){return!!e&&"error"in e&&"object"==typeof e.error&&null!==e.error&&"description"in e.error&&"string"==typeof e.error.description&&!("_id"in e)}function w(i){var a;!function(){const e=["EventSource","ReadableStream","fetch"].filter(e=>!(e in window));if(e.length>0)throw new Error(`Browser not supported. Missing browser APIs: ${e.join(", ")}`)}();const m=null!=(a=i.EventSource)?a:window.EventSource;if(i.token){if(!i.EventSource)throw new Error("When the `token` option is used the `EventSource` option must also be provided.");if(i.EventSource===window.EventSource)throw new Error("When the `token` option is used the `EventSource` option must also be provided. EventSource cannot be `window.EventSource`, as it does not support passing a token.")}return function(i,a){let h=[];const m=r(i.subscriptionThrottleMs||50,function(){w.forEach(E)}),w=[];let v;async function g(){v||(v=function(e,t,{getDocuments:r,EventSource:n}){const{projectId:o,dataset:i,listen:a,overlayDrafts:f,documentLimit:p,token:h,includeTypes:m}=e;if(!a)return{unsubscribe:l,loaded:r({projectId:o,dataset:i,documentLimit:p,token:h,includeTypes:m}).then(_).then(l)};const w=new Map;let v;const g=[];let y,E;const b=new Promise((e,t)=>{y=e,E=t});let S,$,j;return{unsubscribe:c(n,e,{next:function(e){v?(function(e){if(!e.effects||e.documentId.startsWith("_."))return;const t=w.get(e.documentId)||null;!function(e,t){const r=w.get(e),n=v||[],o=r?n.indexOf(r):-1;-1===o&&t?(n.push(t),w.set(e,t)):t?(n.splice(o,1,t),w.set(e,t)):(n.splice(o,1),w.delete(e))}(e.documentId,d(t,e.effects.apply))}(e),function(e,t){clearTimeout(j),$!==t.transactionId&&S?(_(S),$=void 0):($=t.transactionId,S=e.slice()),j=setTimeout(_,25,e.slice())}(v,e)):g.push(e)},open:async function(){const e=await r({projectId:o,dataset:i,documentLimit:p,token:h,includeTypes:m});v=function(e,t){const r=new Map;return t.forEach(e=>{const t=r.get(e.documentId)||[];t.push(e),r.set(e.documentId,t)}),r.forEach((t,r)=>{const n=e.find(e=>e._id===r);if(!n)return void console.warn("Received mutation for missing document %s",r);let o=!1,i=n;t.forEach(e=>{o=o||e.previousRev===n._rev,o&&e.effects&&(i=d(i,e.effects.apply))}),e.splice(e.indexOf(n),1,i)}),e}(e,g),v.forEach(e=>w.set(e._id,e)),_(v),y()},error:e=>E(e)}).unsubscribe,loaded:b};function _(e){S=void 0,j=void 0,$=void 0,t(f?function(e){const t=new Map;return e.forEach(e=>{const r=t.get(u(e));e._id.startsWith("drafts.")?t.set(u(e),function(e){return s({},e,{_id:u(e)})}(e)):r||t.set(e._id,e)}),Array.from(t.values())}(e):e)}}(i,e=>{h=e,m()},a)),await v.loaded}async function y(e,t){await g();const r=n(e,{params:t});return(await o(r,{dataset:h,params:t})).get()}function E(e){return y(e.query,e.params).then(r=>{"previousResult"in e&&t(e.previousResult,r)||(e.previousResult=r,e.callback(void 0,r))}).catch(t=>{e.callback(t)})}return{query:y,getDocument:async function(t){return await g(),y(e(f||(f=p`*[_id == $id][0]`)),{id:t})},getDocuments:async function(e){return await g(),y(`[${e.map(e=>`*[_id == "${e}"][0]`).join(",\n")}]`)},subscribe:function(e,t,r){if(!i.listen)throw new Error("Cannot use `subscribe()` without `listen: true`");const n={query:e,params:t,callback:r};w.push(n);let o=!1;return E(n),{unsubscribe:()=>(o||(o=!0,w.splice(w.indexOf(n),1)),Promise.resolve())}},close:function(){return m.cancel(),v?v.unsubscribe():Promise.resolve()}}}(i,{EventSource:m,getDocuments:h})}export{w as groqStore};
//# sourceMappingURL=groq-store.modern.mjs.map
