var e=require("groq"),r=require("fast-deep-equal"),t=require("throttle-debounce"),n=require("groq-js"),o=require("mendoza");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var u=/*#__PURE__*/i(e),s=/*#__PURE__*/i(r);function c(){return c=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},c.apply(this,arguments)}var a,d=function(e,r,t){(function(e){return"undefined"!=typeof window&&e.addEventListener===window.EventSource.prototype.addEventListener})(e)&&e.addEventListener(r,t,!1),e.addEventListener(r,t)};function f(e,r,t){var n,o=r.token,i=new e("https://"+r.projectId+".api.sanity.io/v1/data/listen/"+r.dataset+"?query=*&effectFormat=mendoza",{withCredentials:!0,headers:o?{Authorization:"Bearer "+o}:void 0});return d(i,"welcome",t.open),d(i,"mutation",(n=t.next,function(e){var r;try{r=JSON.parse(e.data)}catch(e){return}n(r)})),d(i,"channelError",function(e){var r;i.close();try{r=JSON.parse(e.data)}catch(e){return void t.error(new Error("Unknown error parsing listener message"))}t.error(new Error(r.message||r.error||"Listener returned HTTP "+r.statusCode))}),d(i,"error",function(e){var r="undefined"!=typeof window&&window.location.origin,n=r?", and that the CORS-origin ("+r+") is allowed":"",o=function(e){return"object"==typeof e&&null!==e&&"message"in e}(e)?" ("+e.message+")":"";t.error(new Error("Error establishing listener - check that the project ID and dataset are correct"+n+o))}),{unsubscribe:function(){return Promise.resolve(i.close())}}}function v(e){return e._id.startsWith("drafts.")?e._id.slice(7):e._id}function l(e,r){var t=c({},e);return delete t._rev,o.applyPatch(t,r)}function h(){return Promise.resolve()}function p(e,r,t){if(!e.s){if(t instanceof m){if(!t.s)return void(t.o=p.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(p.bind(null,e,r),p.bind(null,e,2));e.s=r,e.v=t;const n=e.o;n&&n(e)}}var m=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(r,t){var n=new e,o=this.s;if(o){var i=1&o?r:t;if(i){try{p(n,1,i(this.v))}catch(e){p(n,2,e)}return n}return this}return this.o=function(e){try{var o=e.v;1&e.s?p(n,1,r?r(o):o):t?p(n,1,t(o)):p(n,2,o)}catch(e){p(n,2,e)}},n},e}();function w(e){return e instanceof m&&1&e.s}var b=function(e){var r=e.projectId,t=e.dataset,n=e.token,o=e.documentLimit,i=e.includeTypes,u=void 0===i?[]:i;try{var s="https://"+r+".api.sanity.io/v1/data/export/"+t,c=u.length>0?new URLSearchParams({types:null==u?void 0:u.join(",")}):"";return Promise.resolve(fetch(s+"?"+c,{credentials:"include",headers:n?{Authorization:"Bearer "+n}:void 0})).then(function(e){function r(r){var t,n,i=function(e){if(!e)throw new Error("Failed to read body from response");var r,t=!1;function n(){t=!0,r&&r.cancel()}return new ReadableStream({start:function(o){r=e.getReader();var i=new TextDecoder,u="";r.read().then(function e(s){try{if(s.done)return t?Promise.resolve():0===(u=u.trim()).length?(o.close(),Promise.resolve()):(o.enqueue(JSON.parse(u)),o.close(),Promise.resolve());for(var c=(u+=i.decode(s.value,{stream:!0})).split("\n"),a=0;a<c.length-1;++a){var d=c[a].trim();if(0!==d.length)try{o.enqueue(JSON.parse(d))}catch(e){return o.error(e),n(),Promise.resolve()}}if(u=c[c.length-1],!r)return Promise.resolve();var f=function(t,n){try{var o=Promise.resolve(r.read()).then(function(r){e(r)})}catch(e){return n(e)}return o&&o.then?o.then(void 0,n):o}(0,function(e){o.error(e)});return Promise.resolve(f&&f.then?f.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}).catch(function(e){return o.error(e)})},cancel:n})}(e.body),u=i.getReader(),s=[],c=function(e,r){var t;do{var n=e();if(n&&n.then){if(!w(n)){t=!0;break}n=n.v}var o=r();if(w(o)&&(o=o.v),!o)return n}while(!o.then);var i=new m,u=p.bind(null,i,2);return(t?n.then(s):o.then(c)).then(void 0,u),i;function s(t){for(n=t;w(o=r())&&(o=o.v),o;){if(o.then)return void o.then(c).then(void 0,u);if((n=e())&&n.then){if(!w(n))return void n.then(s).then(void 0,u);n=n.v}}p(i,1,n)}function c(t){if(t){do{if((n=e())&&n.then){if(!w(n))return void n.then(s).then(void 0,u);n=n.v}if(w(t=r())&&(t=t.v),!t)return void p(i,1,n)}while(!t.then);t.then(c).then(void 0,u)}else p(i,1,n)}}(function(){return Promise.resolve(u.read()).then(function(e){if(function(e){return!!e&&"error"in e&&"object"==typeof e.error&&null!==e.error&&"description"in e.error&&"string"==typeof e.error.description&&!("_id"in e)}(n=(t=e).value))throw new Error("Error streaming dataset: "+n.error);if(n&&!n._id.startsWith("_.")&&s.push(n),o&&s.length>o)throw u.cancel("Reached document limit"),new Error("Error streaming dataset: Reached limit of "+o+" documents. Try using the includeTypes option to reduce the amount of documents, or increase the limit.")})},function(){return!t.done});return c&&c.then?c.then(function(e){return s}):s}var t=function(){if(200!==e.status)return Promise.resolve(e.json()).then(function(e){throw new Error("Error streaming dataset: "+("object"==typeof(r=e)&&"error"in r&&"message"in r?r.message||r.error:"<unknown error>"));var r})}();return t&&t.then?t.then(r):r()})}catch(e){return Promise.reject(e)}};Object.defineProperty(exports,"groq",{enumerable:!0,get:function(){return u.default}}),exports.groqStore=function(e){var r;!function(){var e=["EventSource","ReadableStream","fetch"].filter(function(e){return!(e in window)});if(e.length>0)throw new Error("Browser not supported. Missing browser APIs: "+e.join(", "))}();var o=null!=(r=e.EventSource)?r:window.EventSource;if(e.token){if(!e.EventSource)throw new Error("When the `token` option is used the `EventSource` option must also be provided.");if(e.EventSource===window.EventSource)throw new Error("When the `token` option is used the `EventSource` option must also be provided. EventSource cannot be `window.EventSource`, as it does not support passing a token.")}return function(e,r){var o,i=function(e,r){return Promise.resolve(d()).then(function(){var t=n.parse(e,{params:r});return Promise.resolve(n.evaluate(t,{dataset:p,params:r})).then(function(e){return e.get()})})},d=function(){try{return o||(o=function(e,r,t){var n=t.getDocuments,o=t.EventSource,i=e.projectId,u=e.dataset,s=e.overlayDrafts,a=e.documentLimit,d=e.token,p=e.includeTypes;if(!e.listen)return{unsubscribe:h,loaded:n({projectId:i,dataset:u,documentLimit:a,token:d,includeTypes:p}).then(k).then(h)};var m,w,b,g,y,E,P=new Map,j=[],S=new Promise(function(e,r){w=e,b=r});return{unsubscribe:f(o,e,{next:function(e){m?(function(e){if(e.effects&&!e.documentId.startsWith("_.")){var r=P.get(e.documentId)||null;!function(e,r){var t=P.get(e),n=m||[],o=t?n.indexOf(t):-1;-1===o&&r?(n.push(r),P.set(e,r)):r?(n.splice(o,1,r),P.set(e,r)):(n.splice(o,1),P.delete(e))}(e.documentId,l(r,e.effects.apply))}}(e),function(e,r){clearTimeout(E),y!==r.transactionId&&g?(k(g),y=void 0):(y=r.transactionId,g=e.slice()),E=setTimeout(k,25,e.slice())}(m,e)):j.push(e)},open:function(){try{return Promise.resolve(n({projectId:i,dataset:u,documentLimit:a,token:d,includeTypes:p})).then(function(e){(m=function(e,r){var t=new Map;return r.forEach(function(e){var r=t.get(e.documentId)||[];r.push(e),t.set(e.documentId,r)}),t.forEach(function(r,t){var n=e.find(function(e){return e._id===t});if(n){var o=!1,i=n;r.forEach(function(e){(o=o||e.previousRev===n._rev)&&e.effects&&(i=l(i,e.effects.apply))}),e.splice(e.indexOf(n),1,i)}else console.warn("Received mutation for missing document %s",t)}),e}(e,j)).forEach(function(e){return P.set(e._id,e)}),k(m),w()})}catch(e){return Promise.reject(e)}},error:function(e){return b(e)}}).unsubscribe,loaded:S};function k(e){g=void 0,E=void 0,y=void 0,r(s?function(e){var r=new Map;return e.forEach(function(e){var t=r.get(v(e));e._id.startsWith("drafts.")?r.set(v(e),function(e){return c({},e,{_id:v(e)})}(e)):t||r.set(e._id,e)}),Array.from(r.values())}(e):e)}}(e,function(e){p=e,m()},r)),Promise.resolve(o.loaded).then(function(){})}catch(e){return Promise.reject(e)}},p=[],m=t.throttle(e.subscriptionThrottleMs||50,function(){w.forEach(b)}),w=[];function b(e){return i(e.query,e.params).then(function(r){"previousResult"in e&&s.default(e.previousResult,r)||(e.previousResult=r,e.callback(void 0,r))}).catch(function(r){e.callback(r)})}return{query:i,getDocument:function(e){return Promise.resolve(d()).then(function(){return i(u.default(a||(r=["*[_id == $id][0]"],t||(t=r.slice(0)),r.raw=t,a=r)),{id:e});var r,t})},getDocuments:function(e){return Promise.resolve(d()).then(function(){var r=e.map(function(e){return'*[_id == "'+e+'"][0]'}).join(",\n");return i("["+r+"]")})},subscribe:function(r,t,n){if(!e.listen)throw new Error("Cannot use `subscribe()` without `listen: true`");var o={query:r,params:t,callback:n};w.push(o);var i=!1;return b(o),{unsubscribe:function(){return i||(i=!0,w.splice(w.indexOf(o),1)),Promise.resolve()}}},close:function(){return m.cancel(),o?o.unsubscribe():Promise.resolve()}}}(e,{EventSource:o,getDocuments:b})};
//# sourceMappingURL=groq-store.js.map
